<html> <!-- -*- coding: utf-8 ; mode: xml -*-
 Copyright (C) 2011 Yasuhiro ABE, yasu@yasundial.org.
 Licensed under the Apache License, Version 2.0 (the "License")
-->
<head>
<script type="text/javascript" src="scripts/init.js"></script>
<script type="text/javascript">

var opts_enabled_default = JSON.parse(localStorage.getItem("opts_enabled_default"));
if(opts_enabled_default == undefined) {
  opts_enabled_default = true;
}
var opts_external_link_only_default = JSON.parse(localStorage.getItem("opts_external_link_only_default"));
if(opts_external_link_only_default == undefined) {
  opts_external_link_only_default = false;
}

// note: Until loading the page, the menu1 has been always marked checked.
var menu1;
function menu1OnClick(info,tab) {
    if(tab != undefined && tab.pinned == true) {
	var params = JSON.parse(localStorage.getItem(tab.id));
	if(params != undefined) {
	    params.enabled = ! params.enabled;
	    if(menu1 != undefined) {
		chrome.contextMenus.update(menu1,{"checked": params.enabled});
	    }

	    if(params.enabled == true) {
		chrome.tabs.executeScript(null, {file: "scripts/inject_targets.js"});
	    } else {
		chrome.tabs.executeScript(null, {file: "scripts/remove_targets.js"});
	    }
	    localStorage[tab.id] = JSON.stringify(params);
	}
    }
}

menu1 = chrome.contextMenus.create({"title": "Enabled", "type": "checkbox", "onclick":menu1OnClick, "checked": opts_enabled_default});

function initParams(tabid) {
  params = {
    enabled: opts_enabled_default,
    external_link_only: opts_external_link_only_default
  };
  localStorage[tabid] = JSON.stringify(params);
}
function updateMenu1(tabid, params) {
  if(menu1 != undefined) {
    if(params != undefined) {
      chrome.contextMenus.update(menu1,{"checked": params.enabled});
    } else {
      chrome.contextMenus.update(menu1,{"checked": ! opts_enabled_default});
    }
  }
}

chrome.tabs.onUpdated.addListener(function(id,info,tab) {
  var params = JSON.parse(localStorage.getItem(tab.id));
  if(tab.pinned) {
    if (params == undefined) {
      initParams(tab.id);
      params = JSON.parse(localStorage.getItem(tab.id));
    }
    if (params.enabled == true) {
      chrome.tabs.executeScript(tab.id, {file: "scripts/inject_targets.js"});
    }
  } else {
    if(params != undefined) {
      localStorage.removeItem(tab.id);
      chrome.tabs.executeScript(tab.id, {file: "scripts/remove_targets.js"});
    }
  }
  updateMenu1(tab.id, params);
});

chrome.tabs.onCreated.addListener(function(tab) {
  var params = JSON.parse(localStorage.getItem(tab.id));
  if(tab.pinned) {
    if(params == undefined) {
      initParams(tab.id);
      params = JSON.parse(localStorage.getItem(tab.id));
    }
    if(params.enabled == true) {
      chrome.tabs.executeScript(tab.id, {file: "scripts/inject_targets.js"});
    }
  }
  updateMenu1(tab.id, params);
});

// never create the new item when the params == null
chrome.tabs.onSelectionChanged.addListener(function(id,info) {
  var params = JSON.parse(localStorage.getItem(id));
  updateMenu1(id, params);
});

chrome.tabs.onRemoved.addListener(function(id,info) {
  var params = JSON.parse(localStorage.getItem(id));
  if(params != undefined) {
    localStorage.removeItem(id);
    chrome.tabs.executeScript(null, {file: "scripts/remove_targets.js"});
  }
});
chrome.tabs.onDetached.addListener(function(id,info) {
  var params = JSON.parse(localStorage.getItem(id));
  if(params != undefined) {
    localStorage.removeItem(id);
    chrome.tabs.executeScript(null, {file: "scripts/remove_targets.js"});
  }
});

chrome.windows.onRemoved.addListener(function(windid) {
  localStorage.clear();
  localStorage["opts_enabled_default"] = JSON.stringify(opts_enabled_default);
  localStorage["opts_external_link_only_default"] = JSON.stringify(opts_external_link_only_default);
});

</script>
</head>
</html>
